generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  HOLDER
  ISSUER
  VERIFIER
  ADMIN
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VerifiableCredentialStatus {
  ACTIVE
  REVOKED
  EXPIRED
  DELETED
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String // Хеш пароля
  pin          String // Хеш PIN-коду
  pinAttempts  Int      @default(0) // Лічильник спроб
  role         Role     @default(HOLDER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  // оновлення токена доступу
  refreshToken String?

  // Користувач може представляти одну або кілька організацій
  organizations Organization[]

  // Зв'язки
  credentials  VerifiableCredential[]
  didDocuments DidDocument[]

  schemas              VerifiableCredentialSchema[] // Для Issuer: шаблон документів, які він створив
  verificationSessions VerificationSession[] // Для Verifier: сесії перевірки

  sentRequests VerifiableCredentialRequest[] @relation("HolderRequests")
  receivedRequests VerifiableCredentialRequest[] @relation("IssuerRequests")
}

model DidDocument {
  id                  String  @id @default(uuid())
  did                 String  @unique // Сам рядок DID
  method              String // 'web'
  keyId               String? // ID ключа у документі (наприклад, #key-1), потрібно для підпису
  publicKey           Json // публічний ключ для перевірки підписів
  encryptedPrivateKey String // зашифрований приватний ключ
  encryptionSalt      String
  encryptionIv        String // Вектор ініціалізації (IV) для AES-GCM

  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  deactivatedAt       DateTime?
}

model VerifiableCredential {
  id             String                     @id @default(uuid())
  type           String[] // Наприклад ['VerifiableCredential', 'LegalEntity']
  issuerDid      String // DID емітента
  subjectDid     String // DID організації-отримувача
  payload        Json // Всі дані сертифікату (JSON)
  rawJwt         String // Оригінальний підписаний токен (JWT/SD-JWT)
  status         VerifiableCredentialStatus @default(ACTIVE)
  issuedAt       DateTime
  expiresAt      DateTime?
  //Зв'язок з власником гаманця (користувачем)
  userId         String
  user           User                       @relation(fields: [userId], references: [id])
  //Зв'язок з організацією (юридичною особою)
  organizationId String?
  organization   Organization?              @relation(fields: [organizationId], references: [id])
  createdAt      DateTime                   @default(now())
}

model VerifiableCredentialRequest {
  id          String   @id @default(uuid())
  holderId    String
  holder      User     @relation("HolderRequests", fields: [holderId], references: [id])
  issuerId    String
  issuer      User     @relation("IssuerRequests", fields: [issuerId], references: [id])
  schemaId    String
  schema      VerifiableCredentialSchema @relation(fields: [schemaId], references: [id])
  claimData   Json
  status      RequestStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Organization {
  id      String @id @default(uuid())
  lei     String @unique // LEI код організації
  name    String // Офіційна назва
  country String

  // Зв'язок з представником
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Видані документи цій організації
  credentials VerifiableCredential[]

  createdAt DateTime @default(now())
}

// Схема документа для емітента
model VerifiableCredentialSchema {
  id        String @id @default(uuid())
  name      String // Назва
  schemaId  String // ID схеми в EBSI або IPFS
  structure Json

  issuerId String
  issuer   User   @relation(fields: [issuerId], references: [id])

  verifiableCredentialRequests VerifiableCredentialRequest[]
}

// Verification Session для верифікатора
// запис створюється при генерації посилання
model VerificationSession {
  id     String             @id @default(uuid())
  nonce  String             @unique // Унікальний рядок для захисту від повторів
  status VerificationStatus @default(PENDING)

  // Що ми запитували? (тип документа, дані)
  requestedType String

  // Результат перевірки (хто пред'явив, які дані)
  holderDid     String?
  presentedData Json? // Дані, які надіслав користувач, якщо перевірка успішна

  verifierId String
  verifier   User   @relation(fields: [verifierId], references: [id])

  createdAt DateTime @default(now())
}
