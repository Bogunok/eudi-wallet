
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  HOLDER   // власник гаманця
  ISSUER   // Емітент
  VERIFIER // Верифікатор
}

enum VerifiableCredentialStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

// 1. Користувач (Адміністратор гаманця організації)
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Хеш пароля
  role      Role     @default(HOLDER) // За замовчуванням звичайний користувач
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // оновлення токена доступу
  refreshToken String?
  
  // Зв'язки
  credentials VerifiableCredential[]
  didDocuments DidDocument[]

  schemas     VerifiableCredentialSchema[]    // Для Issuer: шаблон документів, які він створив
  verificationSessions VerificationSession[] // Для Verifier: сесії перевірки
}

// 2. DID 
model DidDocument {
  id         String   @id @default(uuid())
  did        String   @unique // Сам рядок DID
  method     String   // 'key', 'ebsi', 'web'
  keyId      String?  // ID ключа у документі (наприклад, #key-1), потрібно для підпису
  privateKey String  // Зашифрований приватний ключ
  
  userId     String
  user       User     @relation(fields: [userId], references: [id])
}

// 3. Verifiable Credential
model VerifiableCredential {
  id          String   @id @default(uuid())
  type        String[] // Наприклад ['VerifiableCredential', 'LegalEntity']
  issuerDid   String   // DID емітента
  subjectDid  String   // DID організації-отримувача
  payload     Json     // Всі дані сертифікату (JSON)
  rawJwt      String   // Оригінальний підписаний токен (JWT/SD-JWT)
  status      VerifiableCredentialStatus @default(ACTIVE)
  issuedAt    DateTime
  expiresAt   DateTime?
  userId      String
  user        User     @relation(fields: [userId], references: [id])
}

// Схема документа для емітента
model VerifiableCredentialSchema {
  id          String   @id @default(uuid())
  name        String   // Назва
  schemaId    String   // ID схеми в EBSI або IPFS
  structure   Json    
  
  issuerId    String
  issuer      User     @relation(fields: [issuerId], references: [id])
}

// 5. Verification Session для верифікатора
// запис створюється при генерації посилання
model VerificationSession {
  id          String             @id @default(uuid())
  nonce       String             @unique // Унікальний рядок для захисту від повторів
  status      VerificationStatus @default(PENDING)
  
  // Що ми запитували? (наприклад, type: "UniversityDegree")
  requestedType String
  
  // Результат перевірки (хто пред'явив, які дані)
  holderDid   String?
  presentedData Json?  // Дані, які надіслав користувач, якщо перевірка успішна

  verifierId  String
  verifier    User               @relation(fields: [verifierId], references: [id])

  createdAt   DateTime           @default(now())
}